using Microsoft.AspNetCore.Authorization;
using Microsoft.AspNetCore.Mvc;
using Models;
using TijarahJoDB.BLL;
using TijarahJoDBAPI.DTOs.Requests;
using TijarahJoDBAPI.DTOs.Responses;
using TijarahJoDBAPI.DTOs.Mappers;

namespace TijarahJoDBAPI.Controllers
{
    [ApiController]
    [Route("api/TbPosts")]
    public class UserPostsController : ControllerBase
    {
        [HttpGet("All", Name = "GetAllTbUserPosts")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public ActionResult<IEnumerable<PostResponse>> GetAllTbUserPosts()
        {
            var tbuserpostsList = Post.GetAllTbUserPosts();

            if (tbuserpostsList == null || tbuserpostsList.Rows.Count == 0)
            {
                return NotFound("No TbPosts Found!");
            }

            var responseList = new List<PostResponse>();

            foreach (System.Data.DataRow row in tbuserpostsList.Rows)
            {
                responseList.Add(new PostResponse
                {
                    PostID = (int?)row["PostID"],
                    UserID = (int)row["UserID"],
                    CategoryID = (int)row["CategoryID"],
                    PostTitle = (string)row["PostTitle"],
                    PostDescription = row["PostDescription"] == DBNull.Value ? null : (string)row["PostDescription"],
                    Price = row["Price"] == DBNull.Value ? null : (decimal?)row["Price"],
                    Status = (int)row["Status"],
                    CreatedAt = (DateTime)row["CreatedAt"],
                    IsDeleted = (bool)row["IsDeleted"]
                });
            }

            return Ok(responseList);
        }

        [HttpGet("pagination", Name = "GetPostsPaginated")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public ActionResult<IEnumerable<PostResponse>> GetPaginated([FromQuery] GetPaginatedRequest request)
        {
            var tbuserpostsList = Post.GetPaginated(
                request.PageNumber,
                request.RowsPerPage,
                request.IncludeDeleted);

            if (tbuserpostsList == null || tbuserpostsList.Rows.Count == 0)
            {
                return NotFound("No TbPosts Found!");
            }

            var responseList = new List<PostResponse>();

            foreach (System.Data.DataRow row in tbuserpostsList.Rows)
            {
                responseList.Add(new PostResponse
                {
                    PostID = (int?)row["PostID"],
                    UserID = (int)row["UserID"],
                    CategoryID = (int)row["CategoryID"],
                    PostTitle = (string)row["PostTitle"],
                    PostDescription = row["PostDescription"] == DBNull.Value ? null : (string)row["PostDescription"],
                    Price = row["Price"] == DBNull.Value ? null : (decimal?)row["Price"],
                    Status = (int)row["Status"],
                    CreatedAt = (DateTime)row["CreatedAt"],
                    IsDeleted = (bool)row["IsDeleted"]
                });
            }

            return Ok(responseList);
        }

        [HttpGet("{id}", Name = "GetPostById")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public ActionResult<PostResponse> GetPostById(int id)
        {
            if (id < 1)
            {
                return BadRequest($"Not accepted ID {id}");
            }

            Post post = Post.Find(id);

            if (post == null)
            {
                return NotFound($"Post with ID {id} not found.");
            }

            return Ok(post.PostModel.ToResponse());
        }

        [HttpPost(Name = "AddPost")]
        [ProducesResponseType(StatusCodes.Status201Created)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        public ActionResult<PostResponse> AddPost([FromBody] CreatePostRequest request)
        {
            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            Post post = new Post(new PostModel
            (
                null, // PostID - will be generated
                request.UserID,
                request.CategoryID,
                request.PostTitle,
                request.PostDescription,
                request.Price,
                request.Status,
                DateTime.UtcNow, // CreatedAt
                false // IsDeleted
            ));

            if (!post.Save())
            {
                return StatusCode(StatusCodes.Status500InternalServerError, "Error adding Post");
            }

            var response = post.PostModel.ToResponse();

            return CreatedAtRoute("GetPostById", new { id = response.PostID }, response);
        }

        [HttpPut("{id}", Name = "UpdatePost")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public ActionResult<PostResponse> UpdatePost(int id, [FromBody] UpdatePostRequest request)
        {
            if (id < 1)
            {
                return BadRequest($"Not accepted ID {id}");
            }

            if (!ModelState.IsValid)
            {
                return BadRequest(ModelState);
            }

            Post post = Post.Find(id);

            if (post == null)
            {
                return NotFound($"Post with ID {id} not found.");
            }

            post.UserID = request.UserID;
            post.CategoryID = request.CategoryID;
            post.PostTitle = request.PostTitle;
            post.PostDescription = request.PostDescription;
            post.Price = request.Price;
            post.Status = request.Status;
            post.IsDeleted = request.IsDeleted;

            if (!post.Save())
            {
                return StatusCode(StatusCodes.Status500InternalServerError, "Error updating Post");
            }

            return Ok(post.PostModel.ToResponse());
        }

        [HttpDelete("{id}", Name = "DeletePost")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        [ProducesResponseType(StatusCodes.Status404NotFound)]
        public ActionResult DeletePost(int id)
        {
            if (id < 1)
            {
                return BadRequest($"Not accepted ID {id}");
            }

            if (Post.DeletePost(id))
            {
                return Ok($"Post with ID {id} has been deleted.");
            }
            else
            {
                return NotFound($"Post with ID {id} not found. No rows deleted!");
            }
        }

        [HttpGet("Exists/{id}", Name = "DoesPostExist")]
        [ProducesResponseType(StatusCodes.Status200OK)]
        [ProducesResponseType(StatusCodes.Status400BadRequest)]
        public ActionResult<bool> DoesPostExist(int id)
        {
            if (id < 1)
            {
                return BadRequest($"Not accepted ID {id}");
            }

            bool exists = Post.DoesPostExist(id);

            return Ok(exists);
        }
    }
}
