using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using TijarahJoDB.BLL;
using Models;
using TijarahJoDBAPI.DTOs.Requests;
using TijarahJoDBAPI.DTOs.Responses;
using TijarahJoDBAPI.DTOs.Mappers;
using TijarahJoDBAPI.Extensions;
using TijarahJoDBAPI.Services;
using TijarahJoDBAPI.Services.Security;

namespace TijarahJoDBAPI.Controllers
{
    /// <summary>
    /// Comprehensive controller for users and their related resources.
    /// This is a composite controller that manages:
    /// - Users (CRUD operations, authentication)
    /// - User Images (nested under /api/users/{userId}/images)
    /// - User Phone Numbers (nested under /api/users/{userId}/phones)
    /// </summary>
    [ApiController]
    [Route("api/users")]
    [Produces("application/json")]
    public class UsersController : ControllerBase
    {
        // Role ID constants matching database
        private const int RoleId_Admin = 1;
        private const int RoleId_User = 2;
        private const int RoleId_Moderator = 3;

        private readonly TokenService _tokenService;
        private readonly JwtOptions _jwtOptions;
        private readonly ISecurityService _securityService;
        private readonly ImageUploadService _imageUploadService;

        public UsersController(
            TokenService tokenService, 
            JwtOptions jwtOptions,
            ISecurityService securityService,
            ImageUploadService imageUploadService)
        {
            _tokenService = tokenService;
            _jwtOptions = jwtOptions;
            _securityService = securityService;
            _imageUploadService = imageUploadService;
        }

        #region ==================== USER CRUD & AUTHENTICATION ====================

        #region GET - Users

        /// <summary>
        /// Retrieves all users (Admin only)
        /// </summary>
        [HttpGet]
        [Authorize(Roles = RoleNames.Admin)]
        [EndpointSummary("Retrieves all users")]
        [EndpointDescription("Returns a list of all registered users in the system. Admin only.")]
        [ProducesResponseType(typeof(IEnumerable<UserResponse>), StatusCodes.Status200OK)]
        [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status404NotFound)]
        public ActionResult<IEnumerable<UserResponse>> GetAll()
        {
            var usersList = UserBL.GetAllTbUsers();

            if (usersList == null || usersList.Rows.Count == 0)
            {
                return NotFound(new ProblemDetails
                {
                    Title = "No Users Found",
                    Detail = "There are no users registered in the system.",
                    Status = StatusCodes.Status404NotFound
                });
            }

            var responseList = new List<UserResponse>();

            foreach (System.Data.DataRow row in usersList.Rows)
            {
                responseList.Add(new UserResponse
                {
                    UserID = (int?)row["UserID"],
                    Username = (string)row["Username"],
                    Email = (string)row["Email"],
                    FirstName = (string)row["FirstName"],
                    LastName = row["LastName"] == DBNull.Value ? null : (string)row["LastName"],
                    PrimaryPhone = row.Table.Columns.Contains("PrimaryPhone") && row["PrimaryPhone"] != DBNull.Value 
                        ? (string)row["PrimaryPhone"] : null,
                    JoinDate = (DateTime)row["JoinDate"],
                    Status = (int)row["Status"],
                    RoleID = (int)row["RoleID"],
                    IsDeleted = (bool)row["IsDeleted"]
                });
            }

            return Ok(responseList);
        }

        /// <summary>
        /// Retrieves a user by ID
        /// </summary>
        [HttpGet("{id:int}", Name = "GetUserById")]
        [Authorize]
        [EndpointSummary("Retrieves a user by ID")]
        [ProducesResponseType(typeof(UserResponse), StatusCodes.Status200OK)]
        [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status404NotFound)]
        public ActionResult<UserResponse> GetById(int id)
        {
            if (id < 1)
                return BadRequest(new ProblemDetails { Title = "Invalid ID", Status = 400 });

            if (!User.IsOwnerOrAdmin(id))
                return Forbid();

            UserBL user = UserBL.Find(id);
            if (user == null)
                return NotFound(new ProblemDetails { Title = "User Not Found", Status = 404 });

            return Ok(user.UserModel.ToResponse());
        }

        /// <summary>
        /// Gets the current authenticated user's profile
        /// </summary>
        [HttpGet("me")]
        [Authorize]
        [EndpointSummary("Gets current user profile")]
        [ProducesResponseType(typeof(UserResponse), StatusCodes.Status200OK)]
        public ActionResult<UserResponse> GetCurrentUser()
        {
            var userId = User.GetUserId();
            if (userId == null)
                return Unauthorized();

            var user = UserBL.Find(userId);
            if (user == null)
                return NotFound();

            return Ok(user.UserModel.ToResponse());
        }

        /// <summary>
        /// Checks if a user exists
        /// </summary>
        [HttpGet("{id:int}/exists")]
        [Authorize]
        [ProducesResponseType(typeof(bool), StatusCodes.Status200OK)]
        public ActionResult<bool> Exists(int id)
        {
            if (id < 1)
                return BadRequest();
            return Ok(UserBL.DoesUserExist(id));
        }

        #endregion

        #region POST - Users (Registration, Admin Create & Login)

        /// <summary>
        /// Public user registration
        /// </summary>
        [HttpPost("register")]
        [EndpointSummary("Public user registration")]
        [ProducesResponseType(typeof(UserResponse), StatusCodes.Status201Created)]
        [ProducesResponseType(typeof(ValidationProblemDetails), StatusCodes.Status400BadRequest)]
        public ActionResult<UserResponse> Register([FromBody] RegisterUserRequest request)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            string hashedPassword = _securityService.HashPassword(request.Password);

            UserBL user = new UserBL(new UserModel(
                null,
                request.Username,
                hashedPassword,
                request.Email,
                request.FirstName,
                request.LastName,
                DateTime.UtcNow,
                0,
                RoleId_User,
                false
            ));

            bool saved = !string.IsNullOrEmpty(request.PhoneNumber)
                ? user.SaveWithPhone(request.PhoneNumber)
                : user.Save();

            if (!saved)
                return StatusCode(500, new ProblemDetails { Title = "Registration Failed", Status = 500 });

            return CreatedAtRoute("GetUserById", new { id = user.UserID }, user.UserModel.ToResponse());
        }

        /// <summary>
        /// Admin creates a new user with specific role
        /// </summary>
        [HttpPost]
        [Authorize(Roles = RoleNames.Admin)]
        [EndpointSummary("Admin creates user with role")]
        [ProducesResponseType(typeof(UserResponse), StatusCodes.Status201Created)]
        public ActionResult<UserResponse> AdminCreateUser([FromBody] CreateUserRequest request)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            string hashedPassword = _securityService.HashPassword(request.Password);

            UserBL user = new UserBL(new UserModel(
                null,
                request.Username,
                hashedPassword,
                request.Email,
                request.FirstName,
                request.LastName,
                DateTime.UtcNow,
                request.Status,
                request.RoleID,
                false
            ));

            bool saved = !string.IsNullOrEmpty(request.PhoneNumber)
                ? user.SaveWithPhone(request.PhoneNumber)
                : user.Save();

            if (!saved)
                return StatusCode(500, new ProblemDetails { Title = "User Creation Failed", Status = 500 });

            return CreatedAtRoute("GetUserById", new { id = user.UserID }, user.UserModel.ToResponse());
        }

        /// <summary>
        /// Authenticates a user
        /// </summary>
        [HttpPost("login")]
        [EndpointSummary("Authenticates a user")]
        [ProducesResponseType(typeof(LoginResponse), StatusCodes.Status200OK)]
        [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status401Unauthorized)]
        public ActionResult<LoginResponse> Login([FromBody] LoginRequest request)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            UserBL? user = UserBL.FindByLogin(request.Login);
            if (user == null)
                return Unauthorized(new ProblemDetails { Title = "Invalid credentials", Status = 401 });

            if (!_securityService.VerifyPassword(user.HashedPassword, request.Password))
                return Unauthorized(new ProblemDetails { Title = "Invalid credentials", Status = 401 });

            if (user.UserID == null || user.IsDeleted)
                return Unauthorized(new ProblemDetails { Title = "Account disabled", Status = 401 });

            if (_securityService.NeedsRehash(user.HashedPassword))
            {
                user.HashedPassword = _securityService.HashPassword(request.Password);
                user.Save();
            }

            string roleName = GetRoleNameFromId(user.RoleID);
            string token = _tokenService.CreateAuthToken(user.UserID, roleName, user.Username);

            return Ok(new LoginResponse
            {
                User = user.UserModel.ToResponse(),
                Token = token,
                ExpiresAt = DateTime.UtcNow.AddMinutes(_jwtOptions.Lifetime),
                Role = roleName
            });
        }

        private static string GetRoleNameFromId(int roleId) => roleId switch
        {
            RoleId_Admin => RoleNames.Admin,
            RoleId_User => RoleNames.User,
            RoleId_Moderator => RoleNames.Moderator,
            _ => RoleNames.User
        };

        #endregion

        #region PUT - Users

        /// <summary>
        /// Updates user profile (simplified - for users editing their own profile)
        /// </summary>
        [HttpPut("me")]
        [Authorize]
        [EndpointSummary("Updates current user's profile")]
        [EndpointDescription("Allows users to update their own profile info (firstName, lastName, email, username). No password required.")]
        [ProducesResponseType(typeof(UserResponse), StatusCodes.Status200OK)]
        [ProducesResponseType(typeof(ValidationProblemDetails), StatusCodes.Status400BadRequest)]
        public ActionResult<UserResponse> UpdateMyProfile([FromBody] UpdateProfileRequest request)
        {
            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            var userId = User.GetUserId();
            if (userId == null)
                return Unauthorized();

            UserBL user = UserBL.Find(userId);
            if (user == null)
                return NotFound(new ProblemDetails { Title = "User Not Found", Status = 404 });

            // Update allowed fields
            user.FirstName = request.FirstName;
            user.LastName = request.LastName;
            user.Email = request.Email;
            
            if (!string.IsNullOrEmpty(request.Username))
                user.Username = request.Username;

            if (!user.Save())
                return StatusCode(500, new ProblemDetails { Title = "Update Failed", Status = 500 });

            return Ok(user.UserModel.ToResponse());
        }

        /// <summary>
        /// Updates an existing user (Admin or full update)
        /// </summary>
        [HttpPut("{id:int}")]
        [Authorize]
        [EndpointSummary("Updates an existing user")]
        [ProducesResponseType(typeof(UserResponse), StatusCodes.Status200OK)]
        public ActionResult<UserResponse> Update(int id, [FromBody] UpdateUserRequest request)
        {
            if (id < 1)
                return BadRequest();

            if (!User.IsOwnerOrAdmin(id))
                return Forbid();

            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            UserBL user = UserBL.Find(id);
            if (user == null)
                return NotFound();

            // Regular users cannot change their own role
            if (!User.IsAdmin() && request.RoleID != user.RoleID)
                return BadRequest(new ProblemDetails { Title = "Cannot change role", Status = 400 });

            user.Username = request.Username;
            user.HashedPassword = _securityService.HashPassword(request.Password);
            user.Email = request.Email;
            user.FirstName = request.FirstName;
            user.LastName = request.LastName;
            user.Status = request.Status;
            user.RoleID = request.RoleID;
            user.IsDeleted = request.IsDeleted;

            if (!user.Save())
                return StatusCode(500);

            return Ok(user.UserModel.ToResponse());
        }

        /// <summary>
        /// Changes user password
        /// </summary>
        [HttpPut("{id:int}/password")]
        [Authorize]
        [EndpointSummary("Changes user password")]
        [ProducesResponseType(StatusCodes.Status204NoContent)]
        public ActionResult ChangePassword(int id, [FromBody] ChangePasswordRequest request)
        {
            if (id < 1 || !User.IsOwnerOrAdmin(id))
                return Forbid();

            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            var user = UserBL.Find(id);
            if (user == null)
                return NotFound();

            // Verify current password
            if (!User.IsAdmin() || User.GetUserId() == id)
            {
                if (!_securityService.VerifyPassword(user.HashedPassword, request.CurrentPassword))
                    return BadRequest(new ProblemDetails { Title = "Invalid current password", Status = 400 });
            }

            user.HashedPassword = _securityService.HashPassword(request.NewPassword);
            if (!user.Save())
                return StatusCode(500);

            return NoContent();
        }

        #endregion

        #region DELETE - Users

        /// <summary>
        /// Deletes a user
        /// </summary>
        [HttpDelete("{id:int}")]
        [Authorize]
        [ProducesResponseType(StatusCodes.Status204NoContent)]
        public IActionResult Delete(int id)
        {
            if (id < 1 || !User.IsOwnerOrAdmin(id))
                return Forbid();

            if (!UserBL.DeleteUser(id))
                return NotFound();

            return NoContent();
        }

        #endregion

        #endregion

        #region ==================== USER PHONE NUMBERS ====================

        /// <summary>
        /// Gets all phone numbers for a user
        /// </summary>
        [HttpGet("{userId:int}/phones")]
        [Authorize]
        [EndpointSummary("Gets all phone numbers for a user")]
        [EndpointDescription("Returns all phone numbers associated with the user. Users can only view their own phones unless Admin.")]
        [ProducesResponseType(typeof(UserPhonesResponse), StatusCodes.Status200OK)]
        [ProducesResponseType(typeof(ProblemDetails), StatusCodes.Status404NotFound)]
        public ActionResult<UserPhonesResponse> GetPhones(int userId)
        {
            if (userId < 1)
                return BadRequest();

            if (!User.IsOwnerOrAdmin(userId))
                return Forbid();

            if (!UserBL.DoesUserExist(userId))
                return NotFound(new ProblemDetails { Title = "User Not Found", Status = 404 });

            var phones = UserPhoneNumberBL.GetByUserID(userId);
            var phoneResponses = phones.Select(p => p.UserPhoneNumberModel.ToResponse()).ToList();

            return Ok(new UserPhonesResponse
            {
                UserID = userId,
                PhoneNumbers = phoneResponses,
                TotalCount = phoneResponses.Count
            });
        }

        /// <summary>
        /// Gets a specific phone number by ID
        /// </summary>
        [HttpGet("{userId:int}/phones/{phoneId:int}", Name = "GetUserPhoneById")]
        [Authorize]
        [EndpointSummary("Gets a specific phone number")]
        [ProducesResponseType(typeof(UserPhoneResponse), StatusCodes.Status200OK)]
        public ActionResult<UserPhoneResponse> GetPhoneById(int userId, int phoneId)
        {
            if (userId < 1 || phoneId < 1)
                return BadRequest();

            if (!User.IsOwnerOrAdmin(userId))
                return Forbid();

            var phone = UserPhoneNumberBL.Find(phoneId);
            if (phone == null || phone.UserID != userId)
                return NotFound(new ProblemDetails { Title = "Phone Not Found", Status = 404 });

            return Ok(phone.UserPhoneNumberModel.ToResponse());
        }

        /// <summary>
        /// Adds a new phone number for a user
        /// </summary>
        [HttpPost("{userId:int}/phones")]
        [Authorize]
        [EndpointSummary("Adds a new phone number")]
        [EndpointDescription("Adds a new phone number for the user. If isPrimary is true, other phones will be set to non-primary.")]
        [ProducesResponseType(typeof(UserPhoneResponse), StatusCodes.Status201Created)]
        [ProducesResponseType(typeof(ValidationProblemDetails), StatusCodes.Status400BadRequest)]
        public ActionResult<UserPhoneResponse> AddPhone(int userId, [FromBody] CreateUserPhoneRequest request)
        {
            if (userId < 1)
                return BadRequest();

            if (!User.IsOwnerOrAdmin(userId))
                return Forbid();

            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            if (!UserBL.DoesUserExist(userId))
                return NotFound(new ProblemDetails { Title = "User Not Found", Status = 404 });

            var phone = new UserPhoneNumberBL(new UserPhoneNumberModel(
                null,
                userId,
                request.PhoneNumber,
                request.IsPrimary,
                DateTime.UtcNow,
                false
            ));

            if (!phone.Save())
                return StatusCode(500, new ProblemDetails { Title = "Failed to add phone", Status = 500 });

            return CreatedAtRoute(
                "GetUserPhoneById",
                new { userId = userId, phoneId = phone.PhoneID },
                phone.UserPhoneNumberModel.ToResponse()
            );
        }

        /// <summary>
        /// Updates a phone number
        /// </summary>
        [HttpPut("{userId:int}/phones/{phoneId:int}")]
        [Authorize]
        [EndpointSummary("Updates a phone number")]
        [ProducesResponseType(typeof(UserPhoneResponse), StatusCodes.Status200OK)]
        public ActionResult<UserPhoneResponse> UpdatePhone(int userId, int phoneId, [FromBody] UpdateUserPhoneRequest request)
        {
            if (userId < 1 || phoneId < 1)
                return BadRequest();

            if (!User.IsOwnerOrAdmin(userId))
                return Forbid();

            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            var phone = UserPhoneNumberBL.Find(phoneId);
            if (phone == null || phone.UserID != userId)
                return NotFound(new ProblemDetails { Title = "Phone Not Found", Status = 404 });

            phone.PhoneNumber = request.PhoneNumber;
            phone.IsPrimary = request.IsPrimary;
            phone.IsDeleted = request.IsDeleted;

            if (!phone.Save())
                return StatusCode(500);

            return Ok(phone.UserPhoneNumberModel.ToResponse());
        }

        /// <summary>
        /// Deletes a phone number
        /// </summary>
        [HttpDelete("{userId:int}/phones/{phoneId:int}")]
        [Authorize]
        [EndpointSummary("Deletes a phone number")]
        [ProducesResponseType(StatusCodes.Status204NoContent)]
        public IActionResult DeletePhone(int userId, int phoneId)
        {
            if (userId < 1 || phoneId < 1)
                return BadRequest();

            if (!User.IsOwnerOrAdmin(userId))
                return Forbid();

            var phone = UserPhoneNumberBL.Find(phoneId);
            if (phone == null || phone.UserID != userId)
                return NotFound();

            if (!UserPhoneNumberBL.Delete(phoneId))
                return StatusCode(500);

            return NoContent();
        }

        #endregion

        #region ==================== USER IMAGES ====================

        /// <summary>
        /// Retrieves all images for a specific user
        /// </summary>
        [HttpGet("{userId:int}/images")]
        [EndpointSummary("Retrieves all images for a user")]
        [ProducesResponseType(typeof(UserImagesResponse), StatusCodes.Status200OK)]
        public ActionResult<UserImagesResponse> GetAllImages(int userId)
        {
            if (userId < 1)
                return BadRequest();

            if (!UserBL.DoesUserExist(userId))
                return NotFound();

            var imagesTable = UserImage.GetImagesByUserId(userId);
            var images = imagesTable.ToUserImageResponseList();

            return Ok(new UserImagesResponse
            {
                UserID = userId,
                Images = images,
                TotalCount = images.Count
            });
        }

        /// <summary>
        /// Retrieves a specific image for a user
        /// </summary>
        [HttpGet("{userId:int}/images/{imageId:int}", Name = "GetUserImageById")]
        [ProducesResponseType(typeof(UserImageResponse), StatusCodes.Status200OK)]
        public ActionResult<UserImageResponse> GetImageById(int userId, int imageId)
        {
            if (userId < 1 || imageId < 1)
                return BadRequest();

            var image = UserImage.Find(imageId);
            if (image == null || image.UserID != userId)
                return NotFound();

            return Ok(image.UserImageModel.ToResponse());
        }

        /// <summary>
        /// Uploads a new image for a user (via file upload)
        /// </summary>
        [HttpPost("{userId:int}/images/upload")]
        [Authorize]
        [EndpointSummary("Uploads an image file for a user")]
        [Consumes("multipart/form-data")]
        [ProducesResponseType(typeof(ImageUploadResponse), StatusCodes.Status201Created)]
        public async Task<ActionResult<ImageUploadResponse>> UploadImage(int userId, IFormFile file)
        {
            if (userId < 1 || !User.IsOwnerOrAdmin(userId))
                return Forbid();

            if (!UserBL.DoesUserExist(userId))
                return NotFound();

            var uploadResult = await _imageUploadService.UploadUserImageAsync(file, userId);
            if (!uploadResult.Success)
                return BadRequest(new ImageUploadResponse { Success = false, ErrorMessage = uploadResult.ErrorMessage });

            var userImage = new UserImage(new UserImageModel(null, userId, uploadResult.FileUrl!, DateTime.UtcNow, false));
            if (!userImage.Save())
            {
                _imageUploadService.DeleteImage(uploadResult.FileUrl!);
                return StatusCode(500);
            }

            return CreatedAtRoute(
                "GetUserImageById",
                new { userId, imageId = userImage.UserImageID },
                new ImageUploadResponse { Success = true, Image = userImage.UserImageModel.ToResponse(), FileSizeBytes = uploadResult.FileSizeBytes }
            );
        }

        /// <summary>
        /// Uploads a new image for a user (via Base64)
        /// </summary>
        [HttpPost("{userId:int}/images/upload-base64")]
        [Authorize]
        [EndpointSummary("Uploads an image via Base64")]
        [ProducesResponseType(typeof(ImageUploadResponse), StatusCodes.Status201Created)]
        public async Task<ActionResult<ImageUploadResponse>> UploadImageBase64(int userId, [FromBody] UploadUserImageBase64Request request)
        {
            if (userId < 1 || !User.IsOwnerOrAdmin(userId))
                return Forbid();

            if (!ModelState.IsValid)
                return BadRequest(ModelState);

            if (!UserBL.DoesUserExist(userId))
                return NotFound();

            var uploadResult = await _imageUploadService.UploadUserImageFromBase64Async(request.ImageData, userId);
            if (!uploadResult.Success)
                return BadRequest(new ImageUploadResponse { Success = false, ErrorMessage = uploadResult.ErrorMessage });

            var userImage = new UserImage(new UserImageModel(null, userId, uploadResult.FileUrl!, DateTime.UtcNow, false));
            if (!userImage.Save())
            {
                _imageUploadService.DeleteImage(uploadResult.FileUrl!);
                return StatusCode(500);
            }

            return CreatedAtRoute(
                "GetUserImageById",
                new { userId, imageId = userImage.UserImageID },
                new ImageUploadResponse { Success = true, Image = userImage.UserImageModel.ToResponse(), FileSizeBytes = uploadResult.FileSizeBytes }
            );
        }

        /// <summary>
        /// Deletes a user image
        /// </summary>
        [HttpDelete("{userId:int}/images/{imageId:int}")]
        [Authorize]
        [EndpointSummary("Deletes a user image")]
        [ProducesResponseType(StatusCodes.Status204NoContent)]
        public IActionResult DeleteImage(int userId, int imageId)
        {
            if (userId < 1 || imageId < 1 || !User.IsOwnerOrAdmin(userId))
                return Forbid();

            var image = UserImage.Find(imageId);
            if (image == null || image.UserID != userId)
                return NotFound();

            if (!UserImage.DeleteUserImage(imageId))
                return StatusCode(500);

            return NoContent();
        }

        #endregion
    }
}
