-- ============================================================
-- TIJARAHJO: FIX CASCADE DELETE FOR POSTS
-- ============================================================
-- This script fixes the issue where deleting a post with images fails
-- because of foreign key constraints.
-- ============================================================

USE TijarahJoDB; -- Change to your database name
GO

-- ============================================================
-- OPTION 1: UPDATE STORED PROCEDURE (RECOMMENDED)
-- This is the safest approach - delete child records first
-- ============================================================

-- First, let's see what the current SP_DeletePost looks like
PRINT 'Current SP_DeletePost definition:'
PRINT OBJECT_DEFINITION(OBJECT_ID('SP_DeletePost'));
GO

-- Drop and recreate with cascade logic
IF EXISTS (SELECT * FROM sys.procedures WHERE name = 'SP_DeletePost')
BEGIN
    DROP PROCEDURE SP_DeletePost;
END
GO

CREATE PROCEDURE SP_DeletePost
    @PostID INT
AS
BEGIN
    SET NOCOUNT ON;
    
    BEGIN TRY
        BEGIN TRANSACTION;
        
        -- Step 1: Delete all images for this post first
        UPDATE TbPostImages 
        SET IsDeleted = 1 
        WHERE PostID = @PostID;
        
        -- Step 2: Delete all reviews for this post
        UPDATE TbReviews 
        SET IsDeleted = 1 
        WHERE PostID = @PostID;
        
        -- Step 3: Soft delete the post itself
        UPDATE TbPosts 
        SET IsDeleted = 1 
        WHERE PostID = @PostID;
        
        -- Return number of affected rows
        SELECT @@ROWCOUNT AS RowsAffected;
        
        COMMIT TRANSACTION;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;
            
        -- Return 0 to indicate failure
        SELECT 0 AS RowsAffected;
        
        -- Optionally log the error
        -- INSERT INTO ErrorLog (ErrorMessage, ErrorProcedure, ErrorLine)
        -- VALUES (ERROR_MESSAGE(), ERROR_PROCEDURE(), ERROR_LINE());
    END CATCH
END
GO

PRINT 'SP_DeletePost updated successfully!'
GO

-- ============================================================
-- OPTION 2: ADD CASCADE DELETE TO FOREIGN KEY
-- This automatically deletes child records when parent is deleted
-- Use this if you want HARD deletes to cascade
-- ============================================================

/*
-- First, find and drop the existing FK constraint
DECLARE @fkName NVARCHAR(200);
SELECT @fkName = fk.name
FROM sys.foreign_keys fk
JOIN sys.foreign_key_columns fkc ON fk.object_id = fkc.constraint_object_id
WHERE OBJECT_NAME(fk.parent_object_id) = 'TbPostImages'
  AND OBJECT_NAME(fk.referenced_object_id) = 'TbPosts';

IF @fkName IS NOT NULL
BEGIN
    EXEC('ALTER TABLE TbPostImages DROP CONSTRAINT ' + @fkName);
    PRINT 'Dropped FK: ' + @fkName;
END

-- Recreate with CASCADE DELETE
ALTER TABLE TbPostImages
ADD CONSTRAINT FK_PostImages_Posts
FOREIGN KEY (PostID) REFERENCES TbPosts(PostID)
ON DELETE CASCADE
ON UPDATE CASCADE;

PRINT 'FK recreated with CASCADE DELETE'
*/

-- ============================================================
-- OPTION 3: CREATE A COMPREHENSIVE DELETE PROCEDURE
-- For when you need to delete everything related to a post
-- ============================================================

IF EXISTS (SELECT * FROM sys.procedures WHERE name = 'SP_DeletePostCascade')
BEGIN
    DROP PROCEDURE SP_DeletePostCascade;
END
GO

CREATE PROCEDURE SP_DeletePostCascade
    @PostID INT,
    @HardDelete BIT = 0  -- 0 = soft delete, 1 = hard delete
AS
BEGIN
    SET NOCOUNT ON;
    
    DECLARE @RowsAffected INT = 0;
    
    BEGIN TRY
        BEGIN TRANSACTION;
        
        IF @HardDelete = 1
        BEGIN
            -- HARD DELETE - permanently remove records
            
            -- Delete images first (child table)
            DELETE FROM TbPostImages WHERE PostID = @PostID;
            
            -- Delete reviews (child table)
            DELETE FROM TbReviews WHERE PostID = @PostID;
            
            -- Delete the post itself
            DELETE FROM TbPosts WHERE PostID = @PostID;
            SET @RowsAffected = @@ROWCOUNT;
        END
        ELSE
        BEGIN
            -- SOFT DELETE - mark as deleted
            
            -- Soft delete images
            UPDATE TbPostImages 
            SET IsDeleted = 1 
            WHERE PostID = @PostID AND IsDeleted = 0;
            
            -- Soft delete reviews
            UPDATE TbReviews 
            SET IsDeleted = 1 
            WHERE PostID = @PostID AND IsDeleted = 0;
            
            -- Soft delete the post
            UPDATE TbPosts 
            SET IsDeleted = 1 
            WHERE PostID = @PostID AND IsDeleted = 0;
            SET @RowsAffected = @@ROWCOUNT;
        END
        
        COMMIT TRANSACTION;
        
        SELECT @RowsAffected AS RowsAffected;
    END TRY
    BEGIN CATCH
        IF @@TRANCOUNT > 0
            ROLLBACK TRANSACTION;
            
        SELECT 0 AS RowsAffected;
        
        -- For debugging, you can also return error info:
        -- SELECT ERROR_MESSAGE() AS ErrorMessage, ERROR_LINE() AS ErrorLine;
    END CATCH
END
GO

PRINT 'SP_DeletePostCascade created successfully!'
GO

-- ============================================================
-- VERIFICATION: Test the fix
-- ============================================================
/*
-- Test with a post that has images (replace 1 with actual PostID)
EXEC SP_DeletePost @PostID = 1;

-- Check results
SELECT * FROM TbPosts WHERE PostID = 1;
SELECT * FROM TbPostImages WHERE PostID = 1;
SELECT * FROM TbReviews WHERE PostID = 1;
*/

-- ============================================================
-- ALSO FIX: SP_DeletePostImage (in case it has issues too)
-- ============================================================
IF EXISTS (SELECT * FROM sys.procedures WHERE name = 'SP_DeletePostImage')
BEGIN
    DROP PROCEDURE SP_DeletePostImage;
END
GO

CREATE PROCEDURE SP_DeletePostImage
    @PostImageID INT
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Soft delete the image
    UPDATE TbPostImages 
    SET IsDeleted = 1 
    WHERE PostImageID = @PostImageID;
    
    SELECT @@ROWCOUNT AS RowsAffected;
END
GO

PRINT 'SP_DeletePostImage updated successfully!'
GO

-- ============================================================
-- ALSO FIX: SP_DeleteReview (in case it has issues too)
-- ============================================================
IF EXISTS (SELECT * FROM sys.procedures WHERE name = 'SP_DeleteReview')
BEGIN
    DROP PROCEDURE SP_DeleteReview;
END
GO

CREATE PROCEDURE SP_DeleteReview
    @ReviewID INT
AS
BEGIN
    SET NOCOUNT ON;
    
    -- Soft delete the review
    UPDATE TbReviews 
    SET IsDeleted = 1 
    WHERE ReviewID = @ReviewID;
    
    SELECT @@ROWCOUNT AS RowsAffected;
END
GO

PRINT 'SP_DeleteReview updated successfully!'
GO

PRINT ''
PRINT '============================================================'
PRINT 'ALL FIXES APPLIED SUCCESSFULLY!'
PRINT '============================================================'
PRINT 'The delete operation should now work for posts with images.'
PRINT ''
PRINT 'What was fixed:'
PRINT '1. SP_DeletePost now soft-deletes images and reviews before the post'
PRINT '2. SP_DeletePostCascade created for more control (hard/soft delete)'
PRINT '3. SP_DeletePostImage updated to use soft delete'
PRINT '4. SP_DeleteReview updated to use soft delete'
PRINT '============================================================'
