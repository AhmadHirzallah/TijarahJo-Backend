# TijarahJo API - Frontend Integration Guide

> **Base URL:** `https://localhost:7064/api`  
> **Authentication:** JWT Bearer Token  
> **Content-Type:** `application/json`

---

## Quick Start

### 1. Login → Get Token
```http
POST /api/users/login
{ "login": "username_or_email", "password": "your_password" }
```

### 2. Use Token in All Requests
```
Authorization: Bearer <your_token>
```

---

## Authentication

### Register
```http
POST /api/users/register
```
```json
{
  "username": "john_doe",
  "password": "Password123",
  "email": "john@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "phoneNumber": "+962791234567"  // optional
}
```

### Login
```http
POST /api/users/login
```
```json
{
  "login": "john_doe",      // username OR email
  "password": "Password123"
}
```
**Response:**
```json
{
  "user": { "userID": 5, "username": "john_doe", ... },
  "token": "eyJhbG...",
  "expiresAt": "2024-12-26T12:00:00Z",
  "role": "User"
}
```

### Roles
| RoleID | Name | Access |
|--------|------|--------|
| 1 | Admin | Full access |
| 2 | User | Own resources only |
| 3 | Moderator | Limited admin |

---

## Users API

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/users/me` | ✅ | Get current user profile |
| PUT | `/users/me` | ✅ | Update profile (no password needed) |
| GET | `/users/{id}` | ✅ | Get user by ID |
| PUT | `/users/{id}` | ✅ | Full update (requires password) |
| PUT | `/users/{id}/password` | ✅ | Change password |
| DELETE | `/users/{id}` | ✅ | Delete user |
| GET | `/users` | Admin | Get all users |
| POST | `/users` | Admin | Create user with role |

### Update Profile (Simple)
```http
PUT /api/users/me
Authorization: Bearer <token>
```
```json
{
  "firstName": "John",
  "lastName": "Doe",
  "email": "john@example.com",
  "username": "john_updated"
}
```

### Change Password
```http
PUT /api/users/{userId}/password
Authorization: Bearer <token>
```
```json
{
  "currentPassword": "OldPass123",
  "newPassword": "NewPass456"
}
```
**Success:** `204 No Content`  
**Error:** `400` with `"title": "Invalid current password"`

---

## User Phone Numbers

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/users/{userId}/phones` | ✅ | Get all phones |
| POST | `/users/{userId}/phones` | ✅ | Add phone |
| PUT | `/users/{userId}/phones/{phoneId}` | ✅ | Update phone |
| DELETE | `/users/{userId}/phones/{phoneId}` | ✅ | Delete phone |

### Add Phone
```http
POST /api/users/{userId}/phones
Authorization: Bearer <token>
```
```json
{
  "phoneNumber": "+962791234567",
  "isPrimary": true
}
```

---

## User Images

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/users/{userId}/images` | ❌ | Get all images |
| POST | `/users/{userId}/images/upload` | ✅ | Upload file |
| POST | `/users/{userId}/images/upload-base64` | ✅ | Upload base64 |
| DELETE | `/users/{userId}/images/{imageId}` | ✅ | Delete image |

### Upload Image (File)
```http
POST /api/users/{userId}/images/upload
Authorization: Bearer <token>
Content-Type: multipart/form-data

file: <image_file>
```

---

## Posts API

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/posts` | ❌ | Get all posts |
| GET | `/posts/paginated` | ❌ | Get paginated posts |
| GET | `/posts/{id}` | ❌ | Get post by ID |
| GET | `/posts/{id}/details` | ❌ | Get full details with reviews & images |
| POST | `/posts` | ✅ | Create post |
| PUT | `/posts/{id}` | ✅ | Update post (owner/admin) |
| DELETE | `/posts/{id}` | ✅ | Delete post (owner/admin) |

### Get Paginated Posts
```http
GET /api/posts/paginated?pageNumber=1&rowsPerPage=10&categoryID=3
```
**Query Parameters:**
- `pageNumber` (default: 1)
- `rowsPerPage` (default: 10, max: 200)
- `categoryID` (optional)
- `includeDeleted` (default: false)

### Create Post
```http
POST /api/posts
Authorization: Bearer <token>
```
```json
{
  "userID": 5,
  "categoryID": 3,
  "postTitle": "iPhone 15 Pro",
  "postDescription": "Brand new condition",
  "price": 1200.00,
  "status": 0
}
```

### Post Status Values
| Value | Meaning |
|-------|---------|
| 0 | Draft |
| 1 | Pending Review |
| 2 | Active |
| 3 | Sold |

---

## Post Images

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/posts/{postId}/images` | ❌ | Get all images |
| POST | `/posts/{postId}/images/upload` | ✅ | Upload file |
| DELETE | `/posts/{postId}/images/{imageId}` | ✅ | Delete image |

---

## Post Reviews

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/posts/{postId}/reviews` | ❌ | Get all reviews |
| POST | `/posts/{postId}/reviews` | ❌ | Create review |
| DELETE | `/posts/{postId}/reviews/{reviewId}` | ❌ | Delete review |

### Create Review
```http
POST /api/posts/{postId}/reviews
```
```json
{
  "userID": 8,
  "rating": 5,
  "reviewText": "Great product!"
}
```

---

## Categories API

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/categories` | ❌ | Get all categories |
| GET | `/categories/{id}` | ❌ | Get by ID |
| POST | `/categories` | Admin | Create category |
| PUT | `/categories/{id}` | Admin | Update category |
| DELETE | `/categories/{id}` | Admin | Delete category |

---

## Roles API

| Method | Endpoint | Auth | Description |
|--------|----------|------|-------------|
| GET | `/roles` | ❌ | Get all roles |
| GET | `/roles/{id}` | ❌ | Get by ID |
| POST | `/roles` | Admin | Create role |
| PUT | `/roles/{id}` | Admin | Update role |
| DELETE | `/roles/{id}` | Admin | Delete role |

---

## Error Handling

### HTTP Status Codes
| Code | Meaning |
|------|---------|
| 200 | Success |
| 201 | Created |
| 204 | No Content (success, no body) |
| 400 | Bad Request / Validation Error |
| 401 | Unauthorized (no/invalid token) |
| 403 | Forbidden (not allowed) |
| 404 | Not Found |
| 500 | Server Error |

### Error Response Format
```json
{
  "title": "Error Title",
  "detail": "Error description",
  "status": 400
}
```

### Validation Errors
```json
{
  "errors": {
    "Email": ["Invalid email format"],
    "Password": ["Password must be at least 6 characters"]
  }
}
```

---

## Frontend Implementation

### Axios Setup
```javascript
import axios from 'axios';

const api = axios.create({
  baseURL: 'https://localhost:7064/api',
  headers: { 'Content-Type': 'application/json' }
});

// Add token to requests
api.interceptors.request.use(config => {
  const token = localStorage.getItem('token');
  if (token) config.headers.Authorization = `Bearer ${token}`;
  return config;
});

// Handle 401
api.interceptors.response.use(
  response => response,
  error => {
    if (error.response?.status === 401) {
      localStorage.removeItem('token');
      window.location.href = '/login';
    }
    return Promise.reject(error);
  }
);

export default api;
```

### API Functions
```javascript
// Auth
export const login = (data) => api.post('/users/login', data);
export const register = (data) => api.post('/users/register', data);

// Profile
export const getProfile = () => api.get('/users/me');
export const updateProfile = (data) => api.put('/users/me', data);
export const changePassword = (userId, data) => api.put(`/users/${userId}/password`, data);

// Phone Numbers
export const getPhones = (userId) => api.get(`/users/${userId}/phones`);
export const addPhone = (userId, data) => api.post(`/users/${userId}/phones`, data);
export const deletePhone = (userId, phoneId) => api.delete(`/users/${userId}/phones/${phoneId}`);

// Posts
export const getPosts = (params) => api.get('/posts/paginated', { params });
export const getPostDetails = (id) => api.get(`/posts/${id}/details`);
export const createPost = (data) => api.post('/posts', data);
export const updatePost = (id, data) => api.put(`/posts/${id}`, data);
export const deletePost = (id) => api.delete(`/posts/${id}`);

// Images
export const uploadUserImage = (userId, file) => {
  const formData = new FormData();
  formData.append('file', file);
  return api.post(`/users/${userId}/images/upload`, formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  });
};

export const uploadPostImage = (postId, file) => {
  const formData = new FormData();
  formData.append('file', file);
  return api.post(`/posts/${postId}/images/upload`, formData, {
    headers: { 'Content-Type': 'multipart/form-data' }
  });
};

// Categories
export const getCategories = () => api.get('/categories');

// Admin
export const getAllUsers = () => api.get('/users');
export const createUser = (data) => api.post('/users', data);
```

---

## Image Upload Constraints
- **Max Size:** 5 MB
- **Formats:** `.jpg`, `.jpeg`, `.png`, `.gif`, `.webp`

---

## Response Examples

### User Response
```json
{
  "userID": 5,
  "username": "john_doe",
  "email": "john@example.com",
  "firstName": "John",
  "lastName": "Doe",
  "primaryPhone": "+962791234567",
  "joinDate": "2024-01-15T10:30:00Z",
  "status": 0,
  "roleID": 2,
  "isDeleted": false,
  "fullName": "John Doe"
}
```

### Post Details Response
```json
{
  "postID": 1,
  "postTitle": "iPhone 15 Pro",
  "postDescription": "Brand new",
  "price": 1200.00,
  "status": 2,
  "createdAt": "2024-01-10T08:00:00Z",
  "ownerUserID": 5,
  "ownerUsername": "john_doe",
  "ownerFullName": "John Doe",
  "categoryID": 3,
  "categoryName": "Electronics",
  "reviews": [...],
  "images": [...],
  "reviewCount": 5,
  "averageRating": 4.5,
  "imageCount": 3,
  "primaryImageUrl": "/uploads/posts/1/image.jpg"
}
```

### Phone Numbers Response
```json
{
  "userID": 5,
  "phoneNumbers": [
    {
      "phoneID": 1,
      "phoneNumber": "+962791234567",
      "isPrimary": true,
      "createdAt": "2024-01-15T10:30:00Z"
    }
  ],
  "totalCount": 1,
  "primaryPhone": "+962791234567"
}
```

---

## Testing with Swagger
Run the API and visit: `https://localhost:7064/swagger`

---

*Last Updated: December 2024*
