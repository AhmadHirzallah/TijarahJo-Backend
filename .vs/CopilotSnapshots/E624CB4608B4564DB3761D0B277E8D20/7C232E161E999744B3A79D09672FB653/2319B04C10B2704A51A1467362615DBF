using System;
using System.Data;
using Microsoft.Data.SqlClient;
using Models;
using TijarahJoDB_DataAccess;

namespace TijarahJoDB.DAL
{
    /// <summary>
    /// Data Access Layer for User Phone Numbers
    /// One-to-Many relationship: One User can have many Phone Numbers
    /// </summary>
    public class UserPhoneNumberData
    {
        /// <summary>
        /// Gets a phone number by its ID
        /// </summary>
        public static UserPhoneNumberModel? GetByID(int phoneId)
        {
            try
            {
                using var connection = new SqlConnection(clsDataAccessSettings.ConnectionString);
                using var command = new SqlCommand("SP_GetUserPhoneNumberByID", connection);
                
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("@PhoneID", phoneId);

                connection.Open();

                using var reader = command.ExecuteReader();
                if (reader.Read())
                {
                    return new UserPhoneNumberModel(
                        reader.GetInt32(reader.GetOrdinal("PhoneID")),
                        reader.GetInt32(reader.GetOrdinal("UserID")),
                        reader.GetString(reader.GetOrdinal("PhoneNumber")),
                        reader.IsDBNull(reader.GetOrdinal("PhoneType")) ? null : reader.GetString(reader.GetOrdinal("PhoneType")),
                        reader.GetBoolean(reader.GetOrdinal("IsPrimary")),
                        reader.GetDateTime(reader.GetOrdinal("CreatedAt")),
                        reader.GetBoolean(reader.GetOrdinal("IsDeleted"))
                    );
                }

                return null;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"GetByID Error: {ex.Message}");
                return null;
            }
        }

        /// <summary>
        /// Gets all phone numbers for a specific user
        /// </summary>
        public static DataTable GetByUserID(int userId)
        {
            var dt = new DataTable();

            try
            {
                using var connection = new SqlConnection(clsDataAccessSettings.ConnectionString);
                using var command = new SqlCommand("SP_GetUserPhoneNumbers", connection);
                
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("@UserID", userId);

                connection.Open();

                using var reader = command.ExecuteReader();
                if (reader.HasRows)
                    dt.Load(reader);
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"GetByUserID Error: {ex.Message}");
            }

            return dt;
        }

        /// <summary>
        /// Adds a new phone number for a user
        /// </summary>
        public static int Add(UserPhoneNumberModel model)
        {
            try
            {
                using var connection = new SqlConnection(clsDataAccessSettings.ConnectionString);
                using var command = new SqlCommand("SP_AddUserPhoneNumber", connection);
                
                command.CommandType = CommandType.StoredProcedure;

                command.Parameters.Add("@UserID", SqlDbType.Int).Value = model.UserID;
                command.Parameters.Add("@PhoneNumber", SqlDbType.NVarChar, 20).Value = model.PhoneNumber;
                command.Parameters.Add("@PhoneType", SqlDbType.NVarChar, 50).Value = (object?)model.PhoneType ?? DBNull.Value;
                command.Parameters.Add("@IsPrimary", SqlDbType.Bit).Value = model.IsPrimary;

                var outputIdParam = new SqlParameter("@NewPhoneID", SqlDbType.Int)
                {
                    Direction = ParameterDirection.Output
                };
                command.Parameters.Add(outputIdParam);

                connection.Open();
                command.ExecuteNonQuery();

                return (int)outputIdParam.Value;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Add Error: {ex.Message}");
                return -1;
            }
        }

        /// <summary>
        /// Updates an existing phone number
        /// </summary>
        public static bool Update(UserPhoneNumberModel model)
        {
            try
            {
                using var connection = new SqlConnection(clsDataAccessSettings.ConnectionString);
                using var command = new SqlCommand("SP_UpdateUserPhoneNumber", connection);
                
                command.CommandType = CommandType.StoredProcedure;

                command.Parameters.AddWithValue("@PhoneID", model.PhoneID);
                command.Parameters.AddWithValue("@PhoneNumber", model.PhoneNumber);
                command.Parameters.AddWithValue("@PhoneType", (object?)model.PhoneType ?? DBNull.Value);
                command.Parameters.AddWithValue("@IsPrimary", model.IsPrimary);
                command.Parameters.AddWithValue("@IsDeleted", model.IsDeleted);

                connection.Open();
                int rowsAffected = (int)command.ExecuteScalar();

                return rowsAffected > 0;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Update Error: {ex.Message}");
                return false;
            }
        }

        /// <summary>
        /// Soft deletes a phone number
        /// </summary>
        public static bool Delete(int phoneId)
        {
            try
            {
                using var connection = new SqlConnection(clsDataAccessSettings.ConnectionString);
                using var command = new SqlCommand("SP_DeleteUserPhoneNumber", connection);
                
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("@PhoneID", phoneId);

                connection.Open();
                int rowsAffected = (int)command.ExecuteScalar();

                return rowsAffected > 0;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Delete Error: {ex.Message}");
                return false;
            }
        }

        /// <summary>
        /// Checks if a phone number exists
        /// </summary>
        public static bool Exists(int phoneId)
        {
            try
            {
                using var connection = new SqlConnection(clsDataAccessSettings.ConnectionString);
                using var command = new SqlCommand("SP_DoesUserPhoneNumberExist", connection);
                
                command.CommandType = CommandType.StoredProcedure;
                command.Parameters.AddWithValue("@PhoneID", phoneId);

                connection.Open();
                var result = command.ExecuteScalar();

                return result != null && result != DBNull.Value && (bool)result;
            }
            catch (Exception ex)
            {
                System.Diagnostics.Debug.WriteLine($"Exists Error: {ex.Message}");
                return false;
            }
        }
    }
}
