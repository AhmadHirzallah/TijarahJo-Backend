using System;
using System.Data;
using TijarahJoDB.DAL;
using Models;

namespace TijarahJoDB.BLL
{
	public class UserBL
	{
		public enum enMode { AddNew = 0, Update = 1 };
		public enMode Mode = enMode.AddNew;

		public UserModel UserModel
		{
			get { return new UserModel(UserID, Username, HashedPassword, Email, FirstName, LastName, PhoneNumber, JoinDate, Status, RoleID, IsDeleted); }
		}

		public int? UserID { get; set; }
		public string Username { get; set; }
		public string HashedPassword { get; set; }
		public string Email { get; set; }
		public string FirstName { get; set; }
		public string? LastName { get; set; }
		public string? PhoneNumber { get; set; }
		public DateTime JoinDate { get; set; }
		public int Status { get; set; }
		public int RoleID { get; set; }
		public bool IsDeleted { get; set; }

		public UserBL(UserModel UserModel, enMode cMode = enMode.AddNew)
		{
			this.UserID = UserModel.UserID;
			this.Username = UserModel.Username;
			this.HashedPassword = UserModel.HashedPassword;
			this.Email = UserModel.Email;
			this.FirstName = UserModel.FirstName;
			this.LastName = UserModel.LastName;
			this.PhoneNumber = UserModel.PhoneNumber;
			this.JoinDate = UserModel.JoinDate;
			this.Status = UserModel.Status;
			this.RoleID = UserModel.RoleID;
			this.IsDeleted = UserModel.IsDeleted;
			Mode = cMode;
		}

        /// <summary>
        /// Finds a user by username or email for login
        /// Does NOT verify password - that should be done by the security service
        /// </summary>
        public static UserBL? FindByLogin(string login)
        {
            UserModel? userModel = UserData.GetUserByLogin(login);

            if (userModel != null)
                return new UserBL(userModel, enMode.Update);

            return null;
        }

        /// <summary>
        /// Legacy login method - kept for backward compatibility
        /// </summary>
        [Obsolete("Use FindByLogin and verify password with SecurityService instead")]
        public static UserBL Login(string login, string hashedPassword)
        {
            UserModel userModel = UserData.GetUserByLoginAndPassword(login, hashedPassword);

            if (userModel != null)
                return new UserBL(userModel, enMode.Update);

            return null;
        }

		private bool _AddNewUser()
		{
			this.UserID = UserData.AddUser(UserModel);
			return (this.UserID != -1);
		}

		private bool _UpdateUser()
		{
			return UserData.UpdateUser(UserModel);
		}

		public static UserBL Find(int? UserID)
		{
			UserModel UserModel = UserData.GetUserByID(UserID);

			if (UserModel != null)
				return new UserBL(UserModel, enMode.Update);
			else
				return null;
		}

		public bool Save()
		{
			switch (Mode)
			{
				case enMode.AddNew:
					if (_AddNewUser())
					{
						Mode = enMode.Update;
						return true;
					}
					else
					{
						return false;
					}

				case enMode.Update:
					return _UpdateUser();
			}
			return false;
		}

		public static bool DeleteUser(int? UserID)
			=> UserData.DeleteUser(UserID);
			
		public static bool DoesUserExist(int? UserID)
			=> UserData.DoesUserExist(UserID);
			
		public static DataTable GetAllTbUsers()
			=> UserData.GetAllTbUsers();
	}
}
